{% extends "base.html" %}
{% block content %}
<div class="chat-container">
    <h2>Welcome to the Chatroom, {{ username }}!</h2>
    <div id="chat-box">
        {% if messages %}
            {% for msg in messages %}
                <p><strong>{{ msg.user.username }}:</strong> {{ msg.text }}</p>
            {% endfor %}
        {% endif %}
    </div>
    <form id="chat-form">
        <input type="text" id="chat-input" placeholder="Type your message..." autocomplete="off">
        <button type="submit">Send</button>
    </form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const socket = io();
    const roomName = "{{ room.name if room else 'general' }}";
    socket.emit('join', { room: roomName });

    const chatBox = document.getElementById("chat-box");
    const chatForm = document.getElementById("chat-form");
    const chatInput = document.getElementById("chat-input");

    chatForm.addEventListener("submit", function(e) {
        e.preventDefault();
        const msg = chatInput.value;
        if (msg.trim() !== "") {
            socket.emit("send_message", { text: msg, room: roomName });
            chatInput.value = "";
        }
    });

    socket.on("new_message", function(data) {
        const p = document.createElement("p");
        p.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    socket.on("system_message", function(data) {
        const p = document.createElement("p");
        p.innerHTML = `<em>${data.msg}</em>`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
</script>
{% endblock %}
