{% extends "base.html" %}
{% block content %}
<div class="chat-layout">
  <aside class="rooms">
    <h3>Rooms</h3>
    <ul id="rooms">
      {% for r in rooms %}
        <li data-room="{{ r.id }}">{{ r.title or r.room_name }}</li>
      {% endfor %}
    </ul>
  </aside>

  <section class="conversation">
    <div id="messages" class="messages"></div>
    <form id="msgForm">
      <input id="msgInput" autocomplete="off" placeholder="Write a message...">
      <button>Send</button>
    </form>
  </section>

  <aside class="members">
    <h3>{{ current_user.nickname }}</h3>
    <img src="{{ url_for('uploaded_file', filename=current_user.avatar) }}" alt="avatar" class="avatar-small">
    <button onclick="toggleTheme()">Toggle Light</button>
  </aside>
</div>

<script>
  const socket = io();
  let currentRoom = null;

  document.querySelectorAll('#rooms li').forEach(item=>{
    item.onclick = ()=> {
      currentRoom = item.dataset.room;
      socket.emit('join', {room: currentRoom});
      document.getElementById('messages').innerHTML = '';
      // fetch last 50 messages via REST if desired (not implemented here)
    };
  });

  socket.on('message', (msg)=>{
    const el = document.createElement('div');
    el.classList.add('msg');
    el.innerHTML = `<strong>${msg.user.nickname}</strong>: ${msg.content}`;
    document.getElementById('messages').appendChild(el);
  });

  document.getElementById('msgForm').onsubmit = (e)=> {
    e.preventDefault();
    const txt = document.getElementById('msgInput').value;
    if(!currentRoom) return alert('Choose a room first');
    socket.emit('message', {room_id: currentRoom, content: txt});
    document.getElementById('msgInput').value = '';
  };
</script>
{% endblock %}
